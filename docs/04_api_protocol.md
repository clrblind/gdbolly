# Протокол API и WebSocket

## 1. HTTP REST API
Все запросы должны отправляться методом `POST`. Ответы всегда в формате JSON.

### Управление сессией
*   **`POST /session/load`**
    *   **Описание**: Загружает бинарный файл, инициализирует GDB и БД.
    *   **Body**: `{ "path": "/targets/filename" }` (optional, default hardcoded currently).
    *   **Response**: `{ "status": "ok", "comments": {...}, "patches": [...] }`

*   **`POST /session/comment`**
    *   **Описание**: Сохраняет комментарий пользователя.
    *   **Body**: `{ "address": "0x400500", "comment": "Main entry" }`

### Управление отладкой
*   **`POST /control/run`**: Запуск (`-exec-run`).
*   **`POST /control/step_into`**: Шаг с заходом (`-exec-step`).
*   **`POST /control/step_over`**: Шаг с обходом (`-exec-next`).

### Работа с памятью
*   **`POST /memory/disassemble`**
    *   **Body**: `{ "start": "0x400000", "count": 100 }`
    *   **Описание**: Запрашивает дизассемблерный листинг. GDB не умеет "дай 100 инструкций", он умеет "дай диапазон адресов". Бэкенд эвристически вычисляет конечный адрес (`start + count * 8`).

*   **`POST /memory/write`**
    *   **Body**: `{ "address": "0x400000", "bytes": [144, 144] }` (десятичные значения байт).
    *   **Описание**: Записывает байты в память процесса. Создает запись в таблице `patches`.

*   **`POST /memory/revert`**
    *   **Body**: `{ "address": "0x400000" }`
    *   **Описание**: Восстанавливает оригинальные байты по указанному адресу, используя данные из БД.

## 2. WebSocket Протокол
Адрес: `ws://<host>:8000/ws`

Сообщения от сервера к клиенту представляют собой JSON объекты следующей структуры:
```json
{
  "type": "MESSAGE_TYPE",
  "payload": <DATA>
}
```

### Типы сообщений (Message Types)

1.  **`status`**
    *   **Payload**: Строка (`IDLE`, `RUNNING`, `PAUSED`, `EXITED`).
    *   **Описание**: Уведомляет об изменении глобального состояния отладчика.

2.  **`registers`**
    *   **Payload**: Массив объектов `[{number: "0", value: "0x0"}, ...]`.
    *   **Описание**: Приходит автоматически при остановке (PAUSED). Содержит значения всех регистров.

3.  **`disassembly`**
    *   **Payload**: Массив объектов `[{address: "...", inst: "...", opcodes: "..."}, ...]`.
    *   **Описание**: Результат дизассемблирования. (Примечание: в последних версиях инициируется фронтендом через REST, но ответ может прийти и сюда в некоторых случаях, хотя сейчас основной канал — ответ на REST запрос).
    *   *Correction*: В текущей реализации `main.py` REST `/memory/disassemble` не возвращает данные сразу, он шлет команду в GDB. Ответ GDB ловится в `gdb_controller` и отправляется в WS очередь с типом `disassembly`. Так что **WS — это основной канал получения листинга**.

4.  **`thread-update`**
    *   **Payload**: ID текущего потока (string).

5.  **`error`**
    *   **Payload**: Текст ошибки.
